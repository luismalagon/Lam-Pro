rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regla de Autenticación Base: Solo usuarios logueados (anónima o de otra forma) pueden usar la app
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // Colección de Datos Públicos (Rutinas Globales)
    match /artifacts/{appId}/public/data/routines/{docId} {
      allow read: if request.auth != null;
    }

    // Colección de Usuarios Registrados (Lectura limitada para el Admin)
    match /artifacts/{appId}/registered_users/{userId} {
      // Permite la lectura para verificar el rol del usuario actual y permitir la escritura al administrador
      allow read, write: if request.auth.uid == userId || get(/databases/$(database)/documents/artifacts/$(appId)/registered_users/$(request.auth.uid)).data.role == 'admin';
    }

    // Colecciones de Datos del Cliente (Medidas, Metas, Workouts, Comidas)
    // Permite que el usuario lea/escriba sus propios datos
    match /artifacts/{appId}/users/{userId}/{collectionName}/{documentId} {
        allow read, write: if request.auth.uid == userId;
    }
    
    // El administrador puede registrar workouts para CUALQUIER cliente (por su UID)
    match /artifacts/{appId}/users/{clientUid}/workout_records/{documentId} {
        allow write: if get(/databases/$(database)/documents/artifacts/$(appId)/registered_users/$(request.auth.uid)).data.role == 'admin';
        allow read: if request.auth.uid == clientUid;
    }
  }
}