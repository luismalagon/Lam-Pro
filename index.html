<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lam Pro - Aplicación Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LAM Pro">
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" href="favicon.ico">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        /* Estilo para la imagen principal */
        #user-image {
            max-height: 80vh; /* Limita la altura */
            object-fit: contain;
        }
        /* Clases para el menú lateral en móvil */
        .sidebar-visible {
            transform: translateX(0) !important;
        }
        /* Estilo para los inputs de medidas: centrar texto */
        input[type="number"] {
            text-align: center;
        }
        /* Para prevenir la flecha de girar en el ícono de loading */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Ocultar el scrollbar pero permitir scroll */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Estilo para el icono de descarga (si el navegador lo soporta) */
        #install-button {
            display: none; /* Se mostrará con JS si es instalable */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-[100] p-2 rounded-full bg-cyan-500 hover:bg-cyan-600 shadow-lg transition duration-150 ease-in-out">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-800 shadow-xl z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6">LAM Pro</h2>
            <nav class="space-y-3">
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-target="dashboard-view">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0v-6a1 1 0 011-1h2a1 1 0 011 1v6m-4 0h4"></path></svg>
                    Dashboard
                </a>
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-target="measurements-view">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19h12M9 19c-1.397 0-2.603-0.57-3.6-1.57C4.428 16.43 4 15.223 4 14v-4m5 5l12 3"></path></svg>
                    Medidas
                </a>
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-target="routine-view">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Rutina
                </a>
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors duration-150" data-target="meal-analysis-view">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v2m0-4c-1.657 0-3 .895-3 2s1.343 2 3 2m-3-4h6"></path></svg>
                    Análisis Comida
                </a>
            </nav>
            <div class="mt-8 pt-4 border-t border-gray-700">
                <button id="install-button" class="w-full flex items-center justify-center p-3 rounded-lg bg-teal-600 hover:bg-teal-700 transition-colors duration-150 text-white font-semibold">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Instalar App
                </button>
            </div>
            <div class="mt-8 pt-4 border-t border-gray-700">
                <p id="user-status" class="text-sm text-gray-400"></p>
                <p id="auth-status" class="text-sm text-gray-400"></p>
            </div>
        </div>
    </aside>

    <main class="md:ml-64 p-4 transition-all duration-300 ease-in-out">
        <div id="content-container">

            <section id="dashboard-view" class="view">
                <h1 class="text-3xl font-bold mb-6 text-cyan-400">Dashboard</h1>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <h3 class="text-xl font-semibold mb-3">Progreso Semanal (Peso)</h3>
                        <canvas id="weight-chart"></canvas>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                        <h3 class="text-xl font-semibold mb-3">Medidas Clave</h3>
                        <canvas id="measurements-chart"></canvas>
                    </div>
                </div>
                <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h3 class="text-2xl font-semibold mb-4">Mis Metas</h3>
                    <div id="goals-summary" class="text-lg space-y-2">
                        <p>Peso Objetivo: <span id="target-weight" class="font-bold text-teal-400">--</span> kg</p>
                        <p>Déficit/Superávit Calórico: <span id="caloric-goal" class="font-bold text-teal-400">--</span></p>
                        <p>Rutina Activa: <span id="active-routine" class="font-bold text-teal-400">--</span></p>
                    </div>
                </div>
            </section>

            <section id="measurements-view" class="view hidden">
                <h1 class="text-3xl font-bold mb-6 text-cyan-400">Registro de Medidas y Metas</h1>
                
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Medidas de Hoy</h2>
                    <div class="grid sm:grid-cols-3 gap-4">
                        <div>
                            <label for="input-weight" class="block text-sm font-medium text-gray-400">Peso (kg)</label>
                            <input type="number" id="input-weight" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-2 text-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 75.5">
                        </div>
                        <div>
                            <label for="input-chest" class="block text-sm font-medium text-gray-400">Pecho (cm)</label>
                            <input type="number" id="input-chest" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-2 text-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 105">
                        </div>
                        <div>
                            <label for="input-waist" class="block text-sm font-medium text-gray-400">Cintura (cm)</label>
                            <input type="number" id="input-waist" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-2 text-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 80">
                        </div>
                        </div>
                    <button id="save-measurements-btn" class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-colors duration-150">
                        Guardar Medidas
                    </button>
                    <div id="measurements-history" class="mt-4 text-gray-400 hide-scrollbar max-h-40 overflow-y-auto p-2">
                        </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Mis Metas Personales</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label for="target-weight-input" class="block text-sm font-medium text-gray-400">Peso Objetivo (kg)</label>
                            <input type="number" id="target-weight-input" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-2 text-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 70">
                        </div>
                        <div>
                            <label for="caloric-goal-input" class="block text-sm font-medium text-gray-400">Meta Calórica Diaria</label>
                            <input type="text" id="caloric-goal-input" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-2 text-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 2000 kcal / Mantenimiento">
                        </div>
                    </div>
                    <button id="save-goals-btn" class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors duration-150">
                        Guardar Metas
                    </button>
                </div>
            </section>

            <section id="routine-view" class="view hidden">
                <h1 class="text-3xl font-bold mb-6 text-cyan-400">Rutinas y Workouts</h1>
                
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Iniciar Workout (QR)</h2>
                    <div id="qr-reader" class="w-full h-64 bg-gray-900 rounded-md mb-4 flex items-center justify-center text-gray-500">
                        <p id="qr-reader-placeholder">Cámara inactiva. Pulsa Iniciar Escáner.</p>
                    </div>
                    <button id="start-scan-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors duration-150">
                        Iniciar Escáner QR
                    </button>
                    <p id="scan-result" class="mt-3 text-center text-lg font-mono text-yellow-400">Esperando escaneo...</p>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Mi Rutina Global</h2>
                    <div id="routine-display" class="space-y-4">
                        <p class="text-gray-400">Cargando rutina...</p>
                    </div>
                    <button id="save-daily-routine-btn" class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-colors duration-150">
                        Guardar Progreso de Rutina
                    </button>
                </div>
            </section>

            <section id="meal-analysis-view" class="view hidden">
                <h1 class="text-3xl font-bold mb-6 text-cyan-400">Análisis de Comida (Gemini)</h1>

                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Capturar / Seleccionar Imagen</h2>
                    
                    <div class="w-full h-64 bg-gray-900 rounded-md mb-4 flex items-center justify-center overflow-hidden">
                        <img id="meal-preview" class="object-cover w-full h-full" src="" alt="Previsualización de la comida" style="display: none;">
                        <p id="preview-placeholder" class="text-gray-500">Selecciona o toma una foto.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button id="capture-photo-btn" class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-colors duration-150">
                            Tomar Foto
                        </button>
                        <button id="browse-photo-btn" class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-150">
                            Seleccionar Archivo
                        </button>
                    </div>

                    <input type="file" id="meal-file-upload" accept="image/*" style="display: none;">

                    <button id="analyze-meal-btn" class="mt-4 w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 transition-colors duration-150" disabled>
                        Analizar Comida con Gemini
                    </button>
                    
                    <div id="meal-results" class="mt-6 p-4 bg-gray-700 rounded-md hidden">
                        <h3 class="text-xl font-semibold mb-3">Resultado del Análisis:</h3>
                        <p id="analysis-text" class="whitespace-pre-wrap text-gray-200">...</p>
                        <button id="save-meal-btn" class="mt-4 w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 transition-colors duration-150">
                            Guardar Registro de Comida
                        </button>
                    </div>
                    
                </div>
            </section>

        </div>

        <div id="global-message" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 z-[200]"></div>

    </main>

    <script type="module">
        // --- 1. CONFIGURACIÓN E IMPORTACIONES DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables Globales
        let auth;
        let db;
        let userId = null;
        let html5QrCode;
        let weightChart;
        let measurementsChart;

        // API Key para Gemini (DEBE SER INYECTADA DESDE UN ENTORNO SEGURO EN PRODUCCIÓN)
        const GEMINI_API_KEY = "TU_API_KEY_DE_GEMINI_AQUI"; // <<-- NO OLVIDES REEMPLAZAR ESTO

        // --- 2. FUNCIONES DE UTILIDAD GENERAL ---

        function showMessage(message, className) {
            const msgElement = document.getElementById('global-message');
            msgElement.textContent = message;
            msgElement.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transition-opacity duration-300 ${className} opacity-100 z-[200]`;
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                msgElement.classList.add('opacity-0');
                msgElement.classList.remove('opacity-100');
            }, 5000);
        }

        function showView(targetId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');
            
            // Cerrar sidebar en móvil al cambiar de vista
            document.getElementById('sidebar').classList.remove('sidebar-visible');
        }

        // --- 3. FUNCIONES DE FIREBASE (CORRECCIÓN CRÍTICA DE CONFIGURACIÓN) ---

        /**
         * Inicializa Firebase con la configuración correcta y establece la autenticación anónima.
         * CORRIGE EL ERROR "auth/configuration-not-found".
         */
        async function initFirebaseAndAuth() {
            try {
                // INICIO DE LA CORRECCIÓN CRÍTICA: Configuración REAL de Firebase del proyecto lampro-app
                const realFirebaseConfig = {
                    apiKey: "AIzaSyC73cmkc8184lm8FOQmJEDFLGcRhsRc-Qg",
                    authDomain: "lampro-app.firebaseapp.com",
                    projectId: "lampro-app",
                    storageBucket: "lampro-app.firebasestorage.app",
                    messagingSenderId: "94364412200",
                    appId: "1:94364412200:web:030b281f61e5a639e8481d"
                };
                // FIN DE LA CORRECCIÓN CRÍTICA

                const app = initializeApp(realFirebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                document.getElementById('auth-status').textContent = 'Estado: Inicializando Firebase...';

                // Listener de cambio de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `Conectado: ${userId.substring(0, 8)}...`;
                        document.getElementById('user-status').textContent = 'Autenticación Anónima (ACTIVA)';
                        
                        // Carga de datos inicial
                        loadAllUserData();
                        showView('dashboard-view');
                    } else {
                        userId = null;
                        document.getElementById('auth-status').textContent = 'Desconectado';
                        signInAnonymously(auth)
                            .then(() => {
                                // Éxito: onAuthStateChanged manejará la siguiente lógica
                            })
                            .catch((error) => {
                                console.error("Error al iniciar sesión anónimamente:", error);
                                showMessage(`Error de Autenticación: ${error.code}`, 'bg-red-700');
                            });
                    }
                });
            } catch (e) {
                console.error("Error CRÍTICO al inicializar Firebase:", e);
                showMessage('Error crítico: No se pudo inicializar Firebase.', 'bg-red-700');
            }
        }

        // --- 4. FUNCIONES DE LECTURA Y ESCRITURA DE DATOS (Firestore) ---

        async function loadAllUserData() {
            if (!userId) return;
            
            // 4.1 Cargar Metas
            const goalsRef = doc(db, "users", userId, "goals", "current");
            const goalsSnap = await getDoc(goalsRef);
            if (goalsSnap.exists()) {
                const goals = goalsSnap.data();
                document.getElementById('target-weight').textContent = `${goals.targetWeight || '--'} kg`;
                document.getElementById('caloric-goal').textContent = goals.caloricGoal || '--';
                document.getElementById('target-weight-input').value = goals.targetWeight || '';
                document.getElementById('caloric-goal-input').value = goals.caloricGoal || '';
            }

            // 4.2 Cargar Rutina Global (solo lectura)
            const routineRef = doc(db, "global", "routine");
            onSnapshot(routineRef, (docSnap) => {
                const routineDisplay = document.getElementById('routine-display');
                if (docSnap.exists()) {
                    const routine = docSnap.data().plan;
                    routineDisplay.innerHTML = `<pre class="whitespace-pre-wrap bg-gray-700 p-4 rounded-md text-sm">${routine}</pre>`;
                    document.getElementById('active-routine').textContent = 'Cargada';
                } else {
                    routineDisplay.innerHTML = `<p class="text-yellow-500">No hay una rutina global definida por el administrador.</p>`;
                    document.getElementById('active-routine').textContent = 'N/A';
                }
            });

            // 4.3 Cargar Gráficos (Escuchadores en tiempo real)
            setupWeightChartListener();
            setupMeasurementsChartListener();
        }
        
        async function saveMeasurements() {
            if (!userId) return showMessage('Error: Usuario no autenticado.', 'bg-red-700');
            
            const weight = parseFloat(document.getElementById('input-weight').value);
            const chest = parseFloat(document.getElementById('input-chest').value);
            const waist = parseFloat(document.getElementById('input-waist').value);
            
            if (isNaN(weight) && isNaN(chest) && isNaN(waist)) {
                return showMessage('Ingresa al menos un valor de medida.', 'bg-yellow-600');
            }

            const data = {
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                timestamp: Date.now(),
                weight: isNaN(weight) ? null : weight,
                chest: isNaN(chest) ? null : chest,
                waist: isNaN(waist) ? null : waist
                // Agregar más campos si es necesario
            };

            try {
                const docRef = doc(db, "users", userId, "measurements", data.date);
                await setDoc(docRef, data, { merge: true });
                showMessage('Medidas guardadas con éxito.', 'bg-cyan-600');
            } catch (e) {
                console.error("Error al guardar medidas: ", e);
                showMessage('Error al guardar medidas.', 'bg-red-700');
            }
        }

        async function saveGoals() {
            if (!userId) return showMessage('Error: Usuario no autenticado.', 'bg-red-700');

            const targetWeight = parseFloat(document.getElementById('target-weight-input').value);
            const caloricGoal = document.getElementById('caloric-goal-input').value.trim();

            if (isNaN(targetWeight) && caloricGoal === '') {
                return showMessage('Ingresa al menos una meta.', 'bg-yellow-600');
            }

            const data = {
                targetWeight: isNaN(targetWeight) ? null : targetWeight,
                caloricGoal: caloricGoal,
                updatedAt: Date.now()
            };

            try {
                const docRef = doc(db, "users", userId, "goals", "current");
                await setDoc(docRef, data, { merge: true });
                showMessage('Metas guardadas con éxito.', 'bg-teal-600');
                loadAllUserData(); // Recargar el dashboard
            } catch (e) {
                console.error("Error al guardar metas: ", e);
                showMessage('Error al guardar metas.', 'bg-red-700');
            }
        }

        async function analyzeMealWithGemini(base64Image) {
            if (!base64Image) return;

            const analyzeBtn = document.getElementById('analyze-meal-btn');
            const resultsDiv = document.getElementById('meal-results');
            const analysisText = document.getElementById('analysis-text');

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Analizando...';
            resultsDiv.classList.add('hidden');
            analysisText.textContent = '';
            showMessage('Enviando imagen a Gemini...', 'bg-purple-600');

            try {
                // **ADVERTENCIA:** Sustituye "TU_API_KEY_DE_GEMINI_AQUI" por tu clave real
                const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro-vision:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: "Analiza esta imagen de comida. Describe los ingredientes, estima las calorías y clasifica la comida según su aporte nutricional (ej: 'Alta en proteínas', 'Rica en carbohidratos'). Formatea el resultado de manera clara con encabezados: Ingredientes, Calorías Estimadas, Clasificación Nutricional, y Sugerencias de Mejora."
                                    },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg", // Asumimos JPEG, se podría mejorar para detectar el tipo real
                                            data: base64Image
                                        }
                                    }
                                ]
                            }
                        ]
                    })
                });

                const json = await response.json();

                if (json.candidates && json.candidates.length > 0) {
                    const resultText = json.candidates[0].content.parts[0].text;
                    analysisText.textContent = resultText;
                    resultsDiv.classList.remove('hidden');
                    showMessage('Análisis de Gemini completado.', 'bg-green-600');
                } else if (json.error) {
                    throw new Error(json.error.message || 'Error desconocido de la API de Gemini.');
                } else {
                    throw new Error('No se pudo obtener una respuesta válida del modelo.');
                }
            } catch (error) {
                console.error("Error al llamar a Gemini:", error);
                analysisText.textContent = `Error en el análisis: ${error.message}`;
                resultsDiv.classList.remove('hidden');
                showMessage('Error en el análisis de comida.', 'bg-red-700');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'Analizar Comida con Gemini';
            }
        }

        async function saveMealRecord() {
            if (!userId) return showMessage('Error: Usuario no autenticado.', 'bg-red-700');
            
            const analysis = document.getElementById('analysis-text').textContent;
            const imageUrl = document.getElementById('meal-preview').src;

            if (!analysis || !imageUrl.startsWith('data:image')) {
                return showMessage('Primero debe realizar un análisis de comida.', 'bg-yellow-600');
            }

            const record = {
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now(),
                analysis: analysis,
            };

            try {
                const mealsCollection = collection(db, "users", userId, "meals");
                await addDoc(mealsCollection, record);
                showMessage('Registro de comida guardado con éxito.', 'bg-teal-600');
                
                // Limpiar la vista
                document.getElementById('meal-preview').src = '';
                document.getElementById('meal-preview').style.display = 'none';
                document.getElementById('preview-placeholder').style.display = 'block';
                document.getElementById('meal-results').classList.add('hidden');
            } catch (e) {
                console.error("Error al guardar el registro de comida: ", e);
                showMessage('Error al guardar el registro de comida.', 'bg-red-700');
            }
        }
        
        // --- Funciones de Gráficos (Chart.js) ---

        function createChart(ctx, chartType, data, options) {
            return new Chart(ctx, {
                type: chartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#a0aec0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    ...options
                }
            });
        }

        async function setupWeightChartListener() {
            if (!userId) return;

            const q = query(collection(db, "users", userId, "measurements"), where("weight", "!=", null));
            
            onSnapshot(q, (snapshot) => {
                const dataPoints = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.weight) {
                        dataPoints.push({ date: data.date, weight: data.weight });
                    }
                });

                dataPoints.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = dataPoints.map(p => p.date);
                const weights = dataPoints.map(p => p.weight);

                if (weightChart) {
                    weightChart.data.labels = labels;
                    weightChart.data.datasets[0].data = weights;
                    weightChart.update();
                } else {
                    const ctx = document.getElementById('weight-chart').getContext('2d');
                    weightChart = createChart(ctx, 'line', {
                        labels: labels,
                        datasets: [{
                            label: 'Peso (kg)',
                            data: weights,
                            borderColor: '#06b6d4',
                            tension: 0.3
                        }]
                    });
                }
            });
        }

        async function setupMeasurementsChartListener() {
             if (!userId) return;

            // Busca el último registro de medidas para el gráfico de radar
            const q = query(collection(db, "users", userId, "measurements"));
            
            onSnapshot(q, (snapshot) => {
                let latestData = null;
                let latestTimestamp = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp > latestTimestamp) {
                        latestTimestamp = data.timestamp;
                        latestData = data;
                    }
                });

                if (latestData) {
                    const labels = ['Pecho', 'Cintura'];
                    const dataValues = [
                        latestData.chest || 0, 
                        latestData.waist || 0
                    ];
                    
                    if (measurementsChart) {
                        measurementsChart.data.datasets[0].data = dataValues;
                        measurementsChart.update();
                    } else {
                        const ctx = document.getElementById('measurements-chart').getContext('2d');
                        measurementsChart = createChart(ctx, 'radar', {
                            labels: labels,
                            datasets: [{
                                label: 'Medidas Recientes (cm)',
                                data: dataValues,
                                backgroundColor: 'rgba(236, 72, 153, 0.2)', // Rosa
                                borderColor: '#ec4899',
                                pointBackgroundColor: '#ec4899'
                            }]
                        }, {
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.2)' },
                                    pointLabels: { color: '#ffffff' },
                                    ticks: { display: false, backdropColor: 'transparent' },
                                    suggestedMin: 50,
                                    suggestedMax: 120
                                }
                            }
                        });
                    }
                }
                
                // Mostrar historial de medidas en la vista de medidas
                const historyDiv = document.getElementById('measurements-history');
                historyDiv.innerHTML = '';
                snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp).slice(0, 5).forEach(doc => {
                    const data = doc.data();
                    const line = document.createElement('p');
                    let text = `${data.date}: `;
                    if (data.weight) text += `Peso: ${data.weight} kg. `;
                    if (data.chest) text += `Pecho: ${data.chest} cm. `;
                    if (data.waist) text += `Cintura: ${data.waist} cm.`;
                    line.textContent = text;
                    historyDiv.appendChild(line);
                });
            });
        }

        // --- Funciones de QR Scanner ---

        function startQRScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                document.getElementById('scan-result').textContent = `Resultado: ${decodedText}`;
                stopQRScanner();
                showMessage(`QR escaneado: ${decodedText}`, 'bg-green-600');
                // Aquí se podría añadir lógica para buscar el workout en Firestore
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const qrReaderPlaceholder = document.getElementById('qr-reader-placeholder');
            qrReaderPlaceholder.style.display = 'none';

            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback, (errorMessage) => {
                // console.log("QR Scan Error:", errorMessage); // Demasiado ruidoso en el log
            })
            .then(() => {
                document.getElementById('start-scan-btn').textContent = 'Detener Escáner QR';
                showMessage('Escáner QR iniciado.', 'bg-yellow-600');
            })
            .catch((err) => {
                document.getElementById('scan-result').textContent = 'Error al iniciar cámara: ' + err;
                qrReaderPlaceholder.style.display = 'block';
            });
        }

        function stopQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then((ignore) => {
                    document.getElementById('start-scan-btn').textContent = 'Iniciar Escáner QR';
                    document.getElementById('qr-reader-placeholder').style.display = 'block';
                }).catch((err) => {
                    console.error("Error al detener el escáner:", err);
                });
            }
        }
        
        async function saveDailyRoutineRecord() {
            if (!userId) return showMessage('Error: Usuario no autenticado.', 'bg-red-700');
            
            const record = {
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now(),
                status: 'Completada', // Esto debe ser dinámico en una versión completa
                details: 'Registro de rutina diaria completada manualmente.'
            };

            try {
                const routinesCollection = collection(db, "users", userId, "dailyRoutines");
                await addDoc(routinesCollection, record);
                showMessage('Progreso de rutina diaria guardado.', 'bg-teal-600');
            } catch (e) {
                console.error("Error al guardar rutina: ", e);
                showMessage('Error al guardar rutina.', 'bg-red-700');
            }
        }
        
        // --- 5. LÓGICA DE INTERFAZ Y EVENT LISTENERS ---

        function setupEventListeners() {
            // Navegación (Links del Menú Lateral)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(link.getAttribute('data-target'));
                });
            });

            // Toggle del Menú Lateral (móvil)
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('sidebar-visible');
            });

            // 5.1 Medidas y Metas
            document.getElementById('save-measurements-btn').addEventListener('click', saveMeasurements);
            document.getElementById('save-goals-btn').addEventListener('click', saveGoals);
            
            // 5.2 Rutina
            const startScanBtn = document.getElementById('start-scan-btn');
            startScanBtn.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    stopQRScanner();
                } else {
                    startQRScanner();
                }
            });
            document.getElementById('save-daily-routine-btn').addEventListener('click', saveDailyRoutineRecord);

            // 5.3 Análisis de Comida
            const mealFileUpload = document.getElementById('meal-file-upload');
            const mealPreview = document.getElementById('meal-preview');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            const analyzeMealBtn = document.getElementById('analyze-meal-btn');
            const saveMealBtn = document.getElementById('save-meal-btn');
            
            // Botón Tomar Foto
            document.getElementById('capture-photo-btn').addEventListener('click', () => {
                mealFileUpload.setAttribute('capture', 'environment'); // Abre la cámara trasera
                mealFileUpload.click();
            });

            // Botón Seleccionar Archivo
            document.getElementById('browse-photo-btn').addEventListener('click', () => {
                mealFileUpload.removeAttribute('capture');
                mealFileUpload.click();
            });

            // Previsualización y habilitación de análisis
            mealFileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        mealPreview.src = e.target.result;
                        mealPreview.style.display = 'block';
                        previewPlaceholder.style.display = 'none';
                        analyzeMealBtn.disabled = false;
                        showMessage('Imagen de comida lista para analizar.', 'bg-gray-600');
                    };
                    reader.readAsDataURL(file);
                } else {
                    mealPreview.style.display = 'none';
                    previewPlaceholder.style.display = 'block';
                    analyzeMealBtn.disabled = true;
                }
            });

            // Botones de Acción de Comida
            analyzeMealBtn.addEventListener('click', () => {
                const base64Image = mealPreview.src.startsWith('data:image') ? mealPreview.src.split(',')[1] : null;
                if (base64Image) {
                    analyzeMealWithGemini(base64Image);
                } else {
                    showMessage('Por favor, selecciona o toma una foto primero.', 'bg-yellow-600');
                }
            });

            saveMealBtn.addEventListener('click', saveMealRecord);
        }

        // --- 6. REGISTRO DEL SERVICE WORKER (PWA FINAL) ---

        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo en el registro del Service Worker:', error);
                    });
            });
        }
        
        // Evento para capturar el prompt de instalación (funciona en Chrome, Edge)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'flex'; // Mostrar botón de instalación
            
            installButton.addEventListener('click', () => {
                installButton.style.display = 'none'; // Ocultar el botón
                deferredPrompt.prompt(); // Muestra el diálogo nativo
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario aceptó el prompt de instalación.');
                    } else {
                        console.log('Usuario rechazó el prompt de instalación.');
                    }
                    deferredPrompt = null;
                });
            });
        });

        // --- Inicio de la Aplicación ---
        window.onload = () => {
            initFirebaseAndAuth();
            setupEventListeners();
        };

    </script>
</body>
</html>